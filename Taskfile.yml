version: '3'

interval: 100ms

env:
  STATIC_DIR: "web/static"

dotenv: [".env"]

tasks:
  # Currently the live tasks are just melting CPU
  # Wait till this is pushed:
  # https://github.com/go-task/task/pull/2048
  live:
    desc: Run live dev environment. (Don't use, melts CPU currently)
    cmds:
      - task live:styles &
      - task live:go

  live:styles:
    cmds:
      - "tailwindcss -i web/styles/tw-input.css -o {{.STATIC_DIR}}/tw-output.css --minify --watch"

  live:go:
    deps: [live:go:run]
    watch: true
    # Copies build:go:app (& deps) so that it gets rerun
    sources:
    - "**/*.go"
    - "**/*.html.tmpl"
    - "sqlc.yaml"
    - "database/queries/**/*.sql"
    - "database/migrations/**/*.sql"

  live:go:run:
    deps: [build:go:app]
    cmds:
      - bin/app

  build:
    desc: Build all artifacts
    deps: [build:go:app, build:go:migrate, build:styles]

  build:go:app:
    deps: [build:go:sqlc]
    env:
      GOARCH: amd64
      GOOS: linux
      CGO_ENABLED: 0
    cmds:
      - go build -o bin/app cmd/app/main.go
    sources:
      - "**/*.go"
      - "**/*.html.tmpl"
    generates:
      - bin/app

  build:go:migrate:
    env:
      GOARCH: amd64
      GOOS: linux
      CGO_ENABLED: 0
    cmds:
      - go build -o bin/migrate cmd/migrate/main.go
    sources:
      - "cmd/migrate/**/*.go"
      - "database/database.go"
      - "database/migrations/**/*.sql"
    generates:
      - bin/migrate

  build:go:sqlc:
    cmds:
      - sqlc generate
    sources:
      - "sqlc.yaml"
      - "database/queries/**/*.sql"
      - "database/migrations/**/*.sql"
    generates:
      - "database/gensql/**/*"

  build:styles:
    cmds:
      - "tailwindcss -i web/styles/tw-input.css -o {{.STATIC_DIR}}/tw-output.css --minify"
    sources:
      - "web/**/*.{html,go}"
      - web/styles/tw-input.css
    generates:
      - web/static/tw-output.css

  run:
    desc: Run Stelo Finance
    cmds:
      - bin/app
    deps: [build]
